<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenges - GreenLink</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="icon" type="image/svg+xml" href="/images/logo.svg">
    <link rel="shortcut icon" type="image/svg+xml" href="/images/logo.svg">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 4rem 0;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='rgba(255,255,255,0.1)' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.2;
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .stats-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: white;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.75rem 2rem rgba(0, 0, 0, 0.12);
        }

        .challenge-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: white;
            height: 100%;
        }

        .challenge-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.75rem 2rem rgba(0, 0, 0, 0.12);
        }

        .challenge-card.completed {
            background: rgba(40, 167, 69, 0.05);
        }

        .btn-category {
            padding: 1rem 1.5rem;
            border-radius: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-category:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn-category.active {
            border: 2px solid currentColor;
            transform: translateY(-2px);
        }

        .btn-category.default {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-category.ambasadoor {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-category.maester {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-category.shelf-whisperer {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-category.cart-goblin {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .btn-category.outline {
            background: white;
            color: #6c757d;
            border: 2px solid #e9ecef;
        }

        .btn-category.outline:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .btn-start {
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
            background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
        }

        .progress {
            height: 0.8rem;
            border-radius: 1rem;
            background-color: rgba(40, 167, 69, 0.1);
            margin: 1rem 0;
        }

        .progress-bar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-radius: 1rem;
        }

        .section-title {
            position: relative;
            display: inline-block;
            margin-bottom: 2rem;
            font-weight: 700;
        }

        .section-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -10px;
            width: 50px;
            height: 3px;
            background: #28a745;
            border-radius: 2px;
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .badge.bg-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }

        .badge.default {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white;
        }

        .badge.ambasadoor {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
            color: white;
        }

        .badge.maester {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
            color: white;
        }

        .badge.shelf-whisperer {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important;
            color: white;
        }

        .badge.cart-goblin {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%) !important;
            color: white;
        }

        .points-badge {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
        }

        .stats-icon {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-light">
<!-- Navbar -->
<nav th:replace="fragments/navbar :: navbar"></nav>

<!-- Hero Section -->
<header class="hero-section">
    <div class="container hero-content">
        <div class="row justify-content-center text-center">
            <div class="col-lg-8">
                <h1 class="display-4 fw-bold mb-3">Environmental Challenges</h1>
                <p class="lead fs-4 mb-0">Complete challenges, earn points, and make a real impact on the environment</p>
            </div>
        </div>
    </div>
</header>

<div class="container py-5">
    <!-- Challenge Categories -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="d-flex gap-3 flex-wrap justify-content-center">
                <button class="btn btn-category default active" data-challenge-type="ALL">
                    <i class="bi bi-grid-3x3-gap"></i>
                    All Challenges
                </button>
                <button class="btn btn-category default outline" data-challenge-type="DEFAULT">
                    <i class="bi bi-person-circle"></i>
                    Default
                </button>
                <button class="btn btn-category ambasadoor outline" data-challenge-type="AMBASADOOR">
                    <i class="bi bi-people-fill"></i>
                    Ambasadoor
                </button>
                <button class="btn btn-category maester outline" data-challenge-type="MAESTER">
                    <i class="bi bi-mortarboard-fill"></i>
                    Maester
                </button>
                <button class="btn btn-category shelf-whisperer outline" data-challenge-type="SHELF_WHISPERER">
                    <i class="bi bi-shop"></i>
                    Shelf Whisperer
                </button>
                <button class="btn btn-category cart-goblin outline" data-challenge-type="CART_GOBLIN">
                    <i class="bi bi-cart3"></i>
                    Cart Goblin
                </button>
            </div>
        </div>
    </div>

    <!-- Progress Overview -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="stats-card">
                <div class="card-body text-center p-4">
                    <i class="bi bi-trophy-fill stats-icon"></i>
                    <h5 class="card-title mb-3">Total Points</h5>
                    <p class="display-6 text-success mb-0 fw-bold" th:text="${totalPoints ?: '0'}">0</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <div class="card-body text-center p-4">
                    <i class="bi bi-check-circle-fill stats-icon"></i>
                    <h5 class="card-title mb-3">Completed</h5>
                    <p class="display-6 text-success mb-0 fw-bold" th:text="${completedCount ?: '0'}">0</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <div class="card-body text-center p-4">
                    <i class="bi bi-lightning-fill stats-icon"></i>
                    <h5 class="card-title mb-3">Current Streak</h5>
                    <p class="display-6 text-success mb-0 fw-bold" th:text="${currentStreak ?: '0'} + ' days'">0 days</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Challenges -->
    <h2 class="section-title">Available Challenges</h2>
    <div id="challengeList" class="row g-4">
        <div th:if="${allChallenges}" th:each="challenge : ${allChallenges}" class="col-md-6">
            <div class="challenge-card">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <span class="badge" th:class="${'badge ' + #strings.toLowerCase(challenge.type).replace('_', '-')}" th:text="${challenge.type}">Default</span>
                        <span class="points-badge">
                            <i class="bi bi-coin me-2"></i>
                            <span th:text="${challenge.points}">5</span> points
                        </span>
                    </div>
                    <h5 class="card-title mb-3" th:text="${challenge.title}">Challenge Title</h5>
                    <p class="card-text text-muted mb-4" th:text="${challenge.description}">Challenge description</p>
                    <button class="btn btn-start w-100" 
                            th:data-challenge-id="${challenge.id}"
                            onclick="startChallenge(this)">
                        <i class="bi bi-play-circle me-2"></i>Start Challenge
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Challenges -->
    <h2 class="section-title mt-5">Active Challenges</h2>
    <div class="row g-4">
        <div th:if="${activeChallenges}" th:each="userChallenge : ${activeChallenges}" class="col-md-6">
            <div class="challenge-card">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <span class="badge" th:class="${'badge ' + #strings.toLowerCase(userChallenge.challenge.type).replace('_', '-')}" th:text="${userChallenge.challenge.type}">Default</span>
                        <span class="points-badge">
                            <i class="bi bi-coin me-2"></i>
                            <span th:text="${userChallenge.challenge.points}">5</span> points
                        </span>
                    </div>
                    <h5 class="card-title mb-3" th:text="${userChallenge.challenge.title}">Challenge Title</h5>
                    <p class="card-text text-muted mb-4" th:text="${userChallenge.challenge.description}">Challenge description</p>
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" 
                             th:style="'width: ' + ${userChallenge.progressPercentage} + '%'"
                             th:attr="aria-valuenow=${userChallenge.progressPercentage}"
                             aria-valuemin="0" aria-valuemax="100"
                             th:text="${userChallenge.progressPercentage + '%'}">
                        </div>
                    </div>
                    <button class="btn btn-start w-100" 
                            th:data-challenge-id="${userChallenge.id}"
                            onclick="updateProgress(this)"
                            th:text="${userChallenge.progressPercentage < 100 ? 'Update Progress' : 'Mark as Complete'}">
                        Update Progress
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Completed Challenges -->
    <h2 class="section-title mt-5">Completed Challenges</h2>
    <div class="row g-4">
        <div th:if="${completedChallenges}" th:each="userChallenge : ${completedChallenges}" class="col-md-6">
            <div class="challenge-card completed">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <span class="badge" th:class="${'badge ' + #strings.toLowerCase(userChallenge.challenge.type).replace('_', '-')}" th:text="${userChallenge.challenge.type}">Default</span>
                        <span class="points-badge">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <span th:text="${userChallenge.challenge.points}">5</span> points earned
                        </span>
                    </div>
                    <h5 class="card-title mb-3" th:text="${userChallenge.challenge.title}">Challenge Title</h5>
                    <p class="card-text text-muted mb-4" th:text="${userChallenge.challenge.description}">Challenge description</p>
                    <small class="text-success">
                        <i class="bi bi-calendar-check me-2"></i>
                        Completed on <span th:text="${#temporals.format(userChallenge.completedAt, 'dd MMM yyyy')}">01 Jan 2024</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer th:replace="fragments/footer :: footer"></footer>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Challenge Scripts -->
<script>
function startChallenge(button) {
    const challengeId = button.getAttribute('data-challenge-id');
    fetch(`/provocari/${challengeId}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.text())
    .then(result => {
        if (result === 'success') {
            window.location.reload();
        } else {
            alert('Failed to start challenge: ' + result);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to start challenge');
    });
}

function updateProgress(button) {
    const challengeId = button.getAttribute('data-challenge-id');
    const progress = prompt('Enter progress percentage (0-100):', '0');
    
    if (progress === null) return;
    
    const progressValue = parseInt(progress);
    if (isNaN(progressValue) || progressValue < 0 || progressValue > 100) {
        alert('Please enter a valid number between 0 and 100');
        return;
    }

    fetch(`/provocari/${challengeId}/progress`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `progress=${progressValue}`
    })
    .then(response => response.text())
    .then(result => {
        if (result === 'success') {
            window.location.reload();
        } else {
            alert('Failed to update progress: ' + result);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update progress');
    });
}

// Category filter functionality
document.querySelectorAll('[data-challenge-type]').forEach(button => {
    button.addEventListener('click', function() {
        // Remove active class and outline from all buttons
        document.querySelectorAll('[data-challenge-type]').forEach(btn => {
            btn.classList.remove('active');
            btn.classList.add('outline');
        });
        
        // Add active class and remove outline from clicked button
        this.classList.add('active');
        this.classList.remove('outline');
        
        const type = this.getAttribute('data-challenge-type');
        filterChallenges(type);
    });
});

function filterChallenges(type) {
    const challenges = document.querySelectorAll('#challengeList .challenge-card');
    challenges.forEach(challenge => {
        const challengeType = challenge.querySelector('.badge').textContent;
        if (type === 'ALL' || challengeType === type) {
            challenge.closest('.col-md-6').style.display = '';
        } else {
            challenge.closest('.col-md-6').style.display = 'none';
        }
    });
}
</script>

<!-- Include the login modal script -->
<div th:replace="fragments/login-modal :: loginModalScript"></div>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy History - GreenLink</title>
    
    <!-- Bootstrap CSS (existing) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/styles.css?v=1.0.2">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- Custom styles for buy history page -->
    <style>
        .buy-history-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 3rem 0;
            border-radius: 0 0 30px 30px;
            margin-bottom: 2rem;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-value {
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
            margin: 0.5rem 0;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .product-info {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .product-price {
            font-size: 1.25rem;
            font-weight: bold;
            color: #28a745;
        }
        
        .btn-review {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }
        
        .btn-review:hover {
            background-color: #218838;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }
        
        /* Ensure proper grid layout */
        .row {
            display: flex;
            flex-wrap: wrap;
        }
        
        .col-lg-4, .col-md-6 {
            display: flex;
        }
        
        /* Debug styling to see card boundaries */
        .product-card {
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav th:replace="fragments/navbar :: navbar"></nav>

    <!-- Header -->
    <div class="buy-history-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-4 fw-bold mb-2">Buy History</h1>
                    <p class="lead mb-0">Track your purchases and spending patterns</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/dashboard" class="btn btn-outline-light rounded-pill">
                        <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Success/Error Messages -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            <span th:text="${success}">Success message</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span th:text="${error}">Error message</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-currency-exchange text-success me-3" style="font-size: 1.5rem;"></i>
                        <h5 class="mb-0">Total Spent</h5>
                    </div>
                    <div class="stats-value" th:text="${'RON ' + #numbers.formatDecimal(totalAmountSpent ?: 0, 1, 2)}">RON 0.00</div>
                    <p class="text-muted mb-0">Total amount spent</p>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-bag-check text-success me-3" style="font-size: 1.5rem;"></i>
                        <h5 class="mb-0">Products Bought</h5>
                    </div>
                    <div class="stats-value" th:text="${totalProductsBought ?: 0}">0</div>
                    <p class="text-muted mb-0">Total items purchased</p>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-calendar-check text-success me-3" style="font-size: 1.5rem;"></i>
                        <h5 class="mb-0">Last Purchase</h5>
                    </div>
                    <div class="stats-value" th:text="${lastPurchaseDate != null ? #temporals.format(lastPurchaseDate, 'MMM dd, yyyy') : 'Never'}">Never</div>
                    <p class="text-muted mb-0">Date of your most recent purchase</p>
                </div>
            </div>
        </div>

        <!-- Monthly Spending Chart -->
        <div class="chart-container">
            <h3 class="mb-3">Monthly Spending</h3>
            <div style="height: 300px;">
                <canvas id="spendingChart"></canvas>
            </div>
        </div>

        <!-- Purchase History -->
        <h3 class="mb-3">Purchase History</h3>
        
        <!-- Debug Info (remove in production) -->
        <div class="alert alert-info mb-3">
            <strong>Debug Info:</strong> 
            Buy History size: <span th:text="${#lists.size(buyHistory ?: {})}">0</span> items
            <div th:if="${#lists.isEmpty(buyHistory)}">
                <p>No purchase history items found. This could be because:</p>
                <ul>
                    <li>You haven't bought any products yet</li>
                    <li>Products you've bought don't have you set as the buyer</li>
                </ul>
            </div>
            <div th:if="${!#lists.isEmpty(buyHistory)}">
                <p>Found the following purchases:</p>
                <ul>
                    <li th:each="purchase, iter : ${buyHistory}" th:if="${iter.index < 3}">
                        Product: <span th:text="${purchase.product.name}">Product Name</span>,
                        Date: <span th:text="${#temporals.format(purchase.purchaseDate, 'MMM dd, yyyy')}">Purchase Date</span>
                    </li>
                    <li th:if="${#lists.size(buyHistory) > 3}">... and more</li>
                </ul>
            </div>
        </div>
        
        <!-- Empty State -->
        <div th:if="${buyHistory == null || #lists.isEmpty(buyHistory)}" class="empty-state">
            <i class="bi bi-bag-x"></i>
            <h4>No purchases yet</h4>
            <p class="text-muted mb-4">Start shopping in our marketplace to see your purchase history here.</p>
            <a href="/marketplace" class="btn btn-success btn-lg rounded-pill">
                <i class="bi bi-shop me-2"></i>Explore Marketplace
            </a>
        </div>
        
        <!-- Product Grid -->
        <div th:if="${buyHistory != null && !#lists.isEmpty(buyHistory)}" class="row">
            <div th:each="purchase : ${buyHistory}" class="col-lg-4 col-md-6 mb-4">
                <div class="product-card">
                    <img th:src="${purchase.product.imageUrl != null ? purchase.product.imageUrl : '/images/placeholder-product.jpg'}" 
                         th:alt="${purchase.product.name != null ? purchase.product.name : 'Product'}" 
                         class="product-image">
                    
                    <div class="product-info">
                        <h5 class="mb-2" th:text="${purchase.product.name != null ? purchase.product.name : 'Product Name'}">Product Name</h5>
                        <p class="text-muted small mb-2" th:text="${'Purchased on ' + (purchase.purchaseDate != null ? #temporals.format(purchase.purchaseDate, 'MMM dd, yyyy') : 'Unknown date')}">Purchased on Jan 01, 2024</p>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="product-price" th:text="${'RON ' + #numbers.formatDecimal(purchase.totalPrice != null ? purchase.totalPrice : 0, 1, 2)}">RON 0.00</div>
                            
                            <div class="d-flex gap-2">
                                <a th:href="@{'/marketplace/product/' + (purchase.product.id != null ? purchase.product.id : 0)}" 
                                   class="btn btn-outline-success btn-sm">
                                    <i class="bi bi-eye me-1"></i>View Again
                                </a>
                                
                                <button th:if="${purchase.hasReview != null && !purchase.hasReview}"
                                        th:onclick="'openReviewModal(' + (purchase.id != null ? purchase.id : 0) + ')'"
                                        class="btn btn-review btn-sm">
                                    <i class="bi bi-star me-1"></i>Leave Review
                                </button>
                                
                                <span th:if="${purchase.hasReview != null && purchase.hasReview}" 
                                      class="badge bg-success">
                                    <i class="bi bi-check-circle me-1"></i>Reviewed
                                </span>
                            </div>
                        </div>
                        
                        <!-- Additional details -->
                        <div class="mt-2">
                            <div th:if="${purchase.quantity != null && purchase.quantity > 1}" class="text-muted small" th:text="${'Quantity: ' + purchase.quantity}">Quantity: 1</div>
                            <div th:if="${purchase.seller != null}" class="text-muted small" th:text="${'Seller: ' + purchase.seller.firstName + ' ' + purchase.seller.lastName}">Seller: John Doe</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Leave a Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/dashboard/buy-history/review}" method="post">
                    <div class="modal-body">
                        <input type="hidden" id="purchaseId" name="purchaseId">
                        
                        <div class="mb-3">
                            <label for="rating" class="form-label">Rating</label>
                            <select class="form-select" id="rating" name="rating" required>
                                <option value="">Select rating</option>
                                <option value="5">⭐⭐⭐⭐⭐ Excellent</option>
                                <option value="4">⭐⭐⭐⭐ Very Good</option>
                                <option value="3">⭐⭐⭐ Good</option>
                                <option value="2">⭐⭐ Fair</option>
                                <option value="1">⭐ Poor</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="comment" class="form-label">Comment</label>
                            <textarea class="form-control" id="comment" name="comment" rows="3" 
                                      placeholder="Share your experience with this product..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Submit Review</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer th:replace="fragments/footer :: footer"></footer>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Include the login modal script -->
    <div th:replace="fragments/login-modal :: loginModalScript"></div>
    
    <!-- Chart.js and Review Modal Scripts -->
    <script th:inline="javascript">
        // Thymeleaf data injection
        /*<![CDATA[*/
        const monthlyData = /*[[${monthlyData}]]*/ [];
        /*]]>*/
        
        // Validate data is an array of 12 numbers
        if (!Array.isArray(monthlyData) || monthlyData.length !== 12) {
            console.warn('Invalid monthly data, using default values');
            monthlyData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
        }
        
        // Ensure all values are numbers
        const chartData = monthlyData.map(val => {
            const num = parseFloat(val);
            return isNaN(num) ? 0 : num;
        });
        
        console.log('Chart data:', chartData);
        
        // Initialize chart when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('spendingChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Spending (RON)',
                            data: chartData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#28a745',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        return 'RON ' + context.parsed.y.toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#6c757d',
                                    callback: function(value) {
                                        return 'RON ' + value;
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#6c757d'
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }
        });
        
        // Review Modal Functions
        function openReviewModal(purchaseId) {
            document.getElementById('purchaseId').value = purchaseId;
            const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
            modal.show();
        }
    </script>
</body>
</html> 
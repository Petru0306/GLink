<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenLink - Lecția 4: Începe un mini-compost acasă</title>
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : 'X-CSRF-TOKEN'}"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="icon" type="image/svg+xml" href="/images/logo.svg">
    <style>
        .course-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        .course-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
            border-radius: 15px;
        }
        .lesson-section {
            background: white;
            border-radius: 15px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #28a745;
        }
        .paragraph-number {
            background: #28a745;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .quiz-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
            border: 2px solid #e9ecef;
        }
        .quiz-option {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .quiz-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            border-color: #28a745;
        }
        .quiz-option.selected {
            border-color: #28a745;
            background-color: #d4edda;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }
        .quiz-option.correct {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .quiz-option.incorrect {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .quiz-section.locked .quiz-option {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .quiz-section.locked .quiz-option:hover {
            transform: none;
            box-shadow: none;
            border-color: #dee2e6;
        }
        .highlight-box {
            background: linear-gradient(135deg, #e8f5e9, #f0f8f0);
            border-left: 5px solid #28a745;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 12px 12px 0;
        }
        .bullet-list {
            padding-left: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .bullet-list li {
            margin-bottom: 1rem;
            position: relative;
            padding-left: 0.5rem;
            line-height: 1.6;
        }
        .section-subtitle {
            color: #28a745;
            font-weight: 600;
            margin: 2rem 0 1rem;
            font-size: 1.3rem;
        }
        .quiz-question {
            margin-bottom: 2.5rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #e9ecef;
        }
        .quiz-question:last-child {
            border-bottom: none;
        }
        .quiz-result {
            text-align: center;
            padding: 2rem;
            border-radius: 15px;
            margin-top: 2rem;
            display: none;
        }
        .quiz-result.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            color: #155724;
        }
        .quiz-result.warning {
            background: linear-gradient(135deg, #fff3cd, #ffeeba);
            border: 2px solid #ffc107;
            color: #856404;
        }
        .progress-container {
            margin: 2rem 0;
        }
        .progress {
            height: 12px;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            background-color: #e9ecef;
        }
        .progress-bar {
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 6px;
        }
        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }
        .points-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        .final-task {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 2.5rem;
            margin-top: 3rem;
            border: 2px solid #dee2e6;
        }
        .task-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }
        .back-button:hover {
            background: #5a6268;
            color: white;
            text-decoration: none;
            transform: translateY(-2px);
        }
        .lesson-completed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border: 2px solid #28a745;
            text-align: center;
        }
        .reflection-input {
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 1rem;
            width: 100%;
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        .reflection-input:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
            outline: none;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navbar -->
    <nav th:replace="fragments/navbar :: navbar"></nav>

    <!-- Course Header -->
    <header class="course-header text-center">
        <div class="container">
            <h1 class="display-4">🌿 Lecția 4: Începe un mini-compost acasă</h1>
            <p class="lead">Transformă resturile în viață nouă</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="course-container">
        <!-- Back Button -->
        <a href="/educatie" class="back-button">
            <i class="bi bi-arrow-left"></i>
            Înapoi la harta cursurilor
        </a>

        <!-- Lesson completed message -->
        <div class="lesson-completed" th:if="${lessonCompleted}" sec:authorize="isAuthenticated()">
            <i class="bi bi-check-circle-fill me-2" style="font-size: 1.5rem;"></i>
            <strong>Felicitări!</strong> Ai completat această lecție cu succes!
        </div>
        
        <!-- Hidden authentication status indicator -->
        <input type="hidden" id="authenticated-status" sec:authorize="isAuthenticated()" value="true">

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-label">
                <span>Progresul lecției</span>
                <span id="progress-text">0/5</span>
            </div>
            <div class="progress">
                <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <!-- Paragraph 1 -->
        <section class="lesson-section">
            <div class="paragraph-number">1</div>
            <h2>Ce este compostul și de ce e important</h2>
            
            <p class="lead mb-4">
                Compostul este un amestec natural de resturi organice — cum ar fi coji de fructe, zaț de cafea, resturi de legume sau frunze uscate — care, în timp, se transformă într-un sol bogat, numit humus.
            </p>

            <p>
                Prin compostare, aceste resturi se descompun în mod natural, fără a produce substanțe toxice. În loc să arunci resturile de mâncare, le poți transforma în viață nouă. Compostarea nu este doar pentru grădinari — oricine poate începe, chiar și într-un apartament!
            </p>

            <div class="highlight-box">
                <h4 class="section-subtitle">De ce este important compostul?</h4>
                <ul class="bullet-list">
                    <li><strong>🌱 Reduce cantitatea de deșeuri</strong> care ajung la groapa de gunoi.</li>
                    <li><strong>🌎 Diminuează emisiile de gaze cu efect de seră</strong>, cum ar fi metanul.</li>
                    <li><strong>🌼 Produce un îngrășământ natural excelent</strong> pentru plante și grădini.</li>
                    <li><strong>💰 Este gratuit și reduce nevoia</strong> de produse chimice.</li>
                </ul>
            </div>

            <!-- Quiz for Paragraph 1 -->
            <div class="quiz-section" data-attempts="0">
                <h4><i class="bi bi-question-circle me-2"></i>Întrebare 1:</h4>
                <p class="mb-3"><strong>Ce este compostul?</strong></p>
                
                <div class="quiz-option" data-correct="false">
                    <strong>A)</strong> Gunoi ars
                </div>
                <div class="quiz-option" data-correct="true">
                    <strong>B)</strong> Sol natural obținut din resturi organice
                </div>
                <div class="quiz-option" data-correct="false">
                    <strong>C)</strong> Plastic reciclat
                </div>
                <div class="quiz-option" data-correct="false">
                    <strong>D)</strong> Îngrășământ chimic
                </div>

                <div class="quiz-result" id="result-1"></div>
            </div>
        </section>

        <!-- Paragraph 2 -->
        <section class="lesson-section">
            <div class="paragraph-number">2</div>
            <h2>De ce este mai bine să compostezi decât să arunci</h2>
            
            <p class="lead mb-4">
                Când alimentele sunt aruncate la gunoi, ele nu se descompun ca în natură. În lipsa oxigenului, în groapa de gunoi, ele emit metan, un gaz de 25 de ori mai puternic decât dioxidul de carbon.
            </p>

            <div class="highlight-box">
                <h4 class="section-subtitle">Știați că:</h4>
                <ul class="bullet-list">
                    <li><strong>🍽️ Aproximativ 1/3 din toată mâncarea produsă</strong> la nivel global se irosește?</li>
                    <li><strong>🗑️ Resturile alimentare reprezintă peste 40%</strong> din gunoiul menajer?</li>
                    <li><strong>🌍 Compostarea acestor resturi ar putea preveni</strong> milioane de tone de emisii nocive?</li>
                </ul>
            </div>

            <p>
                Deci, compostarea nu este doar o metodă ecologică — este o soluție concretă la problema risipei de alimente și a schimbărilor climatice.
            </p>

            <!-- Quiz for Paragraph 2 -->
            <div class="quiz-section" data-attempts="0">
                <h4><i class="bi bi-question-circle me-2"></i>Întrebare 2:</h4>
                <p class="mb-3"><strong>Ce gaz periculos este emis de resturile alimentare în groapa de gunoi?</strong></p>
                
                <div class="quiz-option" data-correct="false">
                    <strong>A)</strong> Oxigen
                </div>
                <div class="quiz-option" data-correct="false">
                    <strong>B)</strong> Azot
                </div>
                <div class="quiz-option" data-correct="true">
                    <strong>C)</strong> Metan
                </div>
                <div class="quiz-option" data-correct="false">
                    <strong>D)</strong> Hidrogen
                </div>

                <div class="quiz-result" id="result-2"></div>
            </div>
        </section>

        <!-- Paragraph 3 -->
        <section class="lesson-section">
            <div class="paragraph-number">3</div>
            <h2>Cum poți începe un mini-compost chiar la tine acasă</h2>
            
            <p class="lead mb-4">
                Nu ai nevoie de o grădină sau un compostor mare. Poți începe un mini-compost într-un borcan, o găleată mică sau un recipient de plastic cu capac.
            </p>

            <div class="highlight-box">
                <h4 class="section-subtitle">Ai nevoie de:</h4>
                <ul class="bullet-list">
                    <li><strong>🥦 Materiale umede (verzi):</strong> coji de fructe, resturi de legume, zaț de cafea.</li>
                    <li><strong>🍂 Materiale uscate (maro):</strong> hârtie ruptă, frunze uscate, carton.</li>
                    <li><strong>💨 Aer:</strong> deschide ocazional capacul pentru aerisire.</li>
                    <li><strong>🌀 Amestec:</strong> combină cele două tipuri pentru echilibru.</li>
                </ul>
            </div>

            <p>
                Păstrează recipientul într-un loc aerisit. Dacă nu ai unde să folosești compostul, îl poți dona unei grădini urbane sau pune în ghivece de flori.
            </p>

            <!-- Quiz for Paragraph 3 -->
            <div class="quiz-section" data-attempts="0">
                <h4><i class="bi bi-question-circle me-2"></i>Întrebare 3:</h4>
                <p class="mb-3"><strong>Care dintre următoarele poate fi pus în compost?</strong></p>
                
                <div class="quiz-option" data-correct="true">
                    <strong>A)</strong> Zaț de cafea
                </div>
                <div class="quiz-option" data-correct="false">
                    <strong>B)</strong> Resturi de plastic
                </div>
                <div class="quiz-option" data-correct="false">
                    <strong>C)</strong> Ambalaje cerate
                </div>
                <div class="quiz-option" data-correct="false">
                    <strong>D)</strong> Paie de plastic
                </div>

                <div class="quiz-result" id="result-3"></div>
            </div>
        </section>

        <!-- Paragraph 4 -->
        <section class="lesson-section">
            <div class="paragraph-number">4</div>
            <h2>Ce NU trebuie pus niciodată în compost</h2>
            
            <p class="lead mb-4">
                La fel cum unele resturi sunt ideale pentru compost, altele trebuie evitate complet, deoarece atrag dăunători, miroase urât sau opresc procesul natural de descompunere.
            </p>

            <div class="highlight-box">
                <h4 class="section-subtitle">Iată ce NU trebuie să pui:</h4>
                <ul class="bullet-list">
                    <li><strong>❌ Carne, lactate, oase</strong></li>
                    <li><strong>❌ Uleiuri sau mâncare gătită</strong></li>
                    <li><strong>❌ Plastic, sticlă, metal</strong></li>
                    <li><strong>❌ Produse de curățenie chimice</strong></li>
                </ul>
            </div>

            <p>
                Regula de bază: dacă e natural și nerafinat, probabil poate fi compostat. În caz de îndoială, mai bine nu-l pui.
            </p>

            <!-- Quiz for Paragraph 4 -->
            <div class="quiz-section" data-attempts="0">
                <h4><i class="bi bi-question-circle me-2"></i>Întrebare 4:</h4>
                <p class="mb-3"><strong>Ce NU ar trebui pus într-un compost?</strong></p>
                
                <div class="quiz-option" data-correct="false">
                    <strong>A)</strong> Carton rupt
                </div>
                <div class="quiz-option" data-correct="false">
                    <strong>B)</strong> Zaț de cafea
                </div>
                <div class="quiz-option" data-correct="false">
                    <strong>C)</strong> Coji de ou
                </div>
                <div class="quiz-option" data-correct="true">
                    <strong>D)</strong> Carne
                </div>

                <div class="quiz-result" id="result-4"></div>
            </div>
        </section>

        <!-- Paragraph 5 -->
        <section class="lesson-section">
            <div class="paragraph-number">5</div>
            <h2>Transformă compostarea într-un obicei zilnic</h2>
            
            <p class="lead mb-4">
                Odată ce începi să compostezi, devine ușor să continui. Ține un borcan sau un recipient aproape de bucătărie, iar în fiecare zi adaugă ce rămâne de la gătit sau mâncat.
            </p>

            <p>
                În câteva săptămâni, vei vedea cum totul se transformă într-un pământ negru, bogat. Este un exemplu minunat de economie circulară — nimic nu se pierde, totul se transformă.
            </p>

            <div class="highlight-box">
                <h4 class="section-subtitle">Compostul poate fi folosit:</h4>
                <ul class="bullet-list">
                    <li><strong>🪴 În ghivece, pentru plante de apartament</strong></li>
                    <li><strong>🌱 În grădini sau jardiniere</strong></li>
                    <li><strong>🤝 Sau chiar donat comunității</strong></li>
                </ul>
            </div>

            <p>
                Fiecare rest pe care îl compostezi înseamnă mai puțin gunoi, mai puține emisii și mai multă viață în sol.
            </p>

            <!-- Quiz for Paragraph 5 -->
            <div class="quiz-section" data-attempts="0">
                <h4><i class="bi bi-question-circle me-2"></i>Întrebare 5:</h4>
                <p class="mb-3"><strong>Ce se întâmplă cu resturile compostate după câteva săptămâni?</strong></p>
                
                <div class="quiz-option" data-correct="false">
                    <strong>A)</strong> Rămân la fel
                </div>
                <div class="quiz-option" data-correct="false">
                    <strong>B)</strong> Se transformă în plastic
                </div>
                <div class="quiz-option" data-correct="true">
                    <strong>C)</strong> Se transformă în pământ fertil
                </div>
                <div class="quiz-option" data-correct="false">
                    <strong>D)</strong> Se usucă și devin toxice
                </div>

                <div class="quiz-result" id="result-5"></div>
            </div>
        </section>

        <!-- Final Task -->
        <section class="final-task">
            <h2 class="text-center mb-4">✅ Sarcina finală</h2>
            
            <div class="task-section">
                <h4><i class="bi bi-camera me-2"></i>📷 Prompt foto (opțional)</h4>
                <p>
                    Fă o poză cu mini-compostul tău — un borcan sau recipient în care ai pus resturi de mâncare potrivite și hârtie.
                </p>
                <input type="file" class="form-control" id="image-upload" accept="image/*">
                <div class="mt-2">
                    <label id="upload-label">Nu ai încă încărcat nicio imagine.</label>
                    <img id="image-preview" src="" alt="Imagine propusă" style="display: none; max-width: 100%; height: auto; margin-top: 10px;">
                </div>
            </div>

            <div class="task-section">
                <h4><i class="bi bi-pencil me-2"></i>✍️ Prompt de reflecție scrisă (obligatoriu)</h4>
                <p class="mb-3">
                    Scrie o propoziție despre cum te-a făcut să te simți acest experiment cu compostul.
                </p>
                <textarea 
                    class="reflection-input" 
                    id="reflection-text" 
                    placeholder="Scrie aici reflecția ta..."
                    rows="4"></textarea>
            </div>

            <div class="text-center">
                <button class="btn btn-success btn-lg" id="complete-lesson" disabled>
                    <i class="bi bi-check-circle me-2"></i>
                    Completează lecția
                </button>
                <p class="mt-2" id="score-display">Puncte: 0/40</p>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer th:replace="fragments/footer :: footer"></footer>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">
                        <i class="bi bi-lock me-2"></i>Autentificare necesară
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Pentru a completa lecția și a-ți salva progresul, trebuie să fii autentificat.</p>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>De ce?</strong> Vrem să-ți salvăm progresul și să-ți oferim o experiență personalizată.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                    <a href="/login" class="btn btn-success">
                        <i class="bi bi-box-arrow-in-right me-2"></i>Autentificare
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let attemptedQuestions = 0;
        const totalQuestions = 5;
        let answers = {};
        let questionScores = {};
        let totalScore = 0;

        // Check if user is authenticated
        function isAuthenticated() {
            // Use a hidden input field that's only rendered for authenticated users
            return document.getElementById('authenticated-status') !== null;
        }

        // Quiz functionality with enhanced scoring
        document.querySelectorAll('.quiz-option').forEach(option => {
            option.addEventListener('click', function() {
                const questionSection = this.closest('.quiz-section');
                const questionNumber = Array.from(document.querySelectorAll('.quiz-section')).indexOf(questionSection) + 1;
                const questionId = `question_${questionNumber}`;
                
                // Check if this question is locked (after second wrong attempt)
                if (questionSection.classList.contains('locked')) {
                    return; // Question is locked, no more attempts allowed
                }
                
                // Check if this question was already answered correctly
                if (questionScores[questionId] === 5) {
                    return; // Question already completed with points
                }
                
                // Remove previous selections in this question
                questionSection.querySelectorAll('.quiz-option').forEach(opt => {
                    opt.classList.remove('selected', 'correct', 'incorrect');
                });
                
                // Select this option
                this.classList.add('selected');
                
                // Check if correct
                const isCorrect = this.getAttribute('data-correct') === 'true';
                
                if (isCorrect) {
                    this.classList.add('correct');
                    
                    // Award points based on attempt number
                    const attempts = parseInt(questionSection.getAttribute('data-attempts') || 0);
                    const points = attempts === 0 ? 5 : 5; // Both attempts give 5 points
                    
                    questionScores[questionId] = points;
                    totalScore += points;
                    
                    if (!answers[questionNumber]) {
                        attemptedQuestions++;
                        answers[questionNumber] = true;
                        updateProgress();
                    }
                    
                    // Show success message
                    const resultDiv = questionSection.querySelector('.quiz-result');
                    resultDiv.style.display = 'block';
                    resultDiv.className = 'quiz-result success';
                    resultDiv.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>Corect! +${points} puncte!`;
                    
                } else {
                    this.classList.add('incorrect');
                    
                    // Increment attempt counter
                    const attempts = parseInt(questionSection.getAttribute('data-attempts') || 0) + 1;
                    questionSection.setAttribute('data-attempts', attempts);
                    
                    if (attempts === 1) {
                        // First wrong attempt - show correct answer and allow second try
                        questionSection.querySelector('[data-correct="true"]').classList.add('correct');
                        
                        const resultDiv = questionSection.querySelector('.quiz-result');
                        resultDiv.style.display = 'block';
                        resultDiv.className = 'quiz-result warning';
                        resultDiv.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i>Greșit! Încearcă din nou. Răspunsul corect este evidențiat.';
                        
                        // Highlight the paragraph with correct information
                        const paragraphSection = questionSection.closest('.lesson-section');
                        paragraphSection.style.backgroundColor = '#fff3cd';
                        paragraphSection.style.borderLeft = '5px solid #ffc107';
                        
                        // Reset after 3 seconds
                        setTimeout(() => {
                            paragraphSection.style.backgroundColor = '';
                            paragraphSection.style.borderLeft = '5px solid #28a745';
                        }, 3000);
                        
                    } else {
                        // Second wrong attempt - no points, show correct answer, lock question
                        questionSection.querySelector('[data-correct="true"]').classList.add('correct');
                        questionSection.classList.add('locked'); // Lock the question
                        
                        const resultDiv = questionSection.querySelector('.quiz-result');
                        resultDiv.style.display = 'block';
                        resultDiv.className = 'quiz-result warning';
                        resultDiv.innerHTML = '<i class="bi bi-x-circle-fill me-2"></i>0 puncte. Răspunsul corect este evidențiat.';
                        
                        // Mark as attempted but with 0 points
                        if (!answers[questionNumber]) {
                            attemptedQuestions++;
                            answers[questionNumber] = true;
                            updateProgress();
                        }
                    }
                }
                
                updateScoreDisplay();
            });
        });

        function updateProgress() {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const percentage = (attemptedQuestions / totalQuestions) * 100;
            
            progressBar.style.width = percentage + '%';
            progressText.textContent = `${attemptedQuestions}/${totalQuestions}`;
            
            // Enable final task if all questions attempted (regardless of points)
            const finalTask = document.querySelector('.final-task');
            if (attemptedQuestions === totalQuestions) {
                finalTask.style.opacity = '1';
                finalTask.style.pointerEvents = 'auto';
            }
            
            // Enable complete button if all questions attempted and reflection written
            const reflectionText = document.getElementById('reflection-text').value.trim();
            const imageUploaded = document.getElementById('image-upload').files.length > 0;
            const completeButton = document.getElementById('complete-lesson');
            completeButton.disabled = !(attemptedQuestions === totalQuestions && reflectionText.length > 0);
        }

        function updateScoreDisplay() {
            const scoreDisplay = document.getElementById('score-display');
            if (scoreDisplay) {
                scoreDisplay.textContent = `Puncte: ${totalScore}/40`;
            }
        }

        // Reflection text input
        document.getElementById('reflection-text').addEventListener('input', function() {
            updateProgress();
        });

        // Image upload handling
        document.getElementById('image-upload').addEventListener('change', function() {
            const file = this.files[0];
            const imagePreview = document.getElementById('image-preview');
            const uploadLabel = document.getElementById('upload-label');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    uploadLabel.textContent = 'Imagine încărcată ✓';
                    uploadLabel.style.color = '#28a745';
                };
                reader.readAsDataURL(file);
            }
        });

        // Complete lesson
        document.getElementById('complete-lesson').addEventListener('click', function() {
            const reflectionText = document.getElementById('reflection-text').value.trim();
            const imageUploaded = document.getElementById('image-upload').files.length > 0;
            
            if (attemptedQuestions === totalQuestions && reflectionText.length > 0) {
                // Check if user is authenticated
                if (!isAuthenticated()) {
                    // Show login modal
                    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                    loginModal.show();
                    return;
                }
                
                // Calculate final score
                let finalScore = totalScore;
                if (reflectionText.length > 0) finalScore += 5; // Reflection points
                if (imageUploaded) finalScore += 10; // Image upload points
                
                // User is authenticated, proceed with completion
                alert(`Felicitări! Ai completat lecția cu succes! 🎉\nPuncte finale: ${finalScore}/40`);
                
                // Mark lesson as completed in localStorage
                localStorage.setItem('lesson_4_completed', 'true');
                localStorage.setItem('lesson_4_score', finalScore);
                
                // Redirect back to education map with completion parameter
                window.location.href = '/educatie?completed=4';
            }
        });

        // Initialize final task as disabled
        document.addEventListener('DOMContentLoaded', function() {
            const finalTask = document.querySelector('.final-task');
            finalTask.style.opacity = '0.5';
            finalTask.style.pointerEvents = 'none';
        });
    </script>
</body>
</html> 